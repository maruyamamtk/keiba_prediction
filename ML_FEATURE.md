## これは何
以下は「競馬予想ML」で効きやすい特徴量アイデアを、漏れ（リーク）に注意しつつ網羅的に整理したものです。かなり多いので、まずは“作りやすい順”に実装していくのが現実的です。

---

## 0) 前提：目的変数とリーク対策

**目的変数**

* 分類：複勝圏内(1/0)→ランク学習を使用する

**リークの典型**

* 発走後に確定する情報（確定オッズ、確定馬体重、確定馬場、出走取消/除外の結果反映、レース後指数など）
* 同一レース内の情報を使った集計で、ターゲットを見てしまう（target encodingのやり方次第で起きる）

**基本分割**

* 必ず時系列分割（例：年単位、月単位、開催単位）
* 同日/同開催を跨いだ情報が混ざらないように（特にTEや平均との差分系）

---

## 1) ベース：レース当日の静的情報（リークしにくい）

**レース条件**

* 競馬場、コース（芝/ダ）、距離、回り（右/左）、直線長、坂有無
* クラス（G1/G2/OP/条件）、年齢条件、牝馬限定など、定量化した“格”
* 頭数、枠順、馬番、内外（例：馬番/頭数、枠の相対位置）
* 斤量、負担重量差（平均との差、同距離平均との差）
* ハンデ戦フラグ、定量戦フラグ

**馬場・天候（“発走前に確定する”範囲で）**

* 当日発表の馬場状態（良/稍/重/不）
* 気温・降水・風（データが取れるなら）
* 当日の同コースの時計傾向（ただし「当日レース結果」から作るとリークになるので注意。前日まで or 発走前に公開される公式指標だけ）

---

## 2) 馬の能力・適性：過去走から作るコア特徴

**過去N走サマリ（N=3,5,10など）**

* 着順、着差、走破タイム、上がり3F、通過順（4角位置など）
* ペース（前半3F/1000m）、ラップ由来（取れれば）
* 走破タイムの“標準化”：同場・同距離・同馬場の平均との差/偏差（自作の馬場補正）
* 斤量補正：タイムや上がりを斤量で補正（線形で十分スタート可）
* “脚質”推定：序盤位置/終盤位置の差、上がり順位、追い込み率など

**条件適性（分解して持つ）**

* 距離適性：距離帯ごとの成績（短/マ/中/長）＋今回距離との差
* コース適性：競馬場別、右左回り、芝ダ別
* 馬場適性：良/重でのパフォーマンス差
* 坂適性：坂有/無の成績差（美浦坂・中山阪神など）
* 季節適性：月別/気温帯（パフォーマンスの周期性が出る馬がいる）

**“近況”**

* 休養日数（前走からの日数）、中○週
* 叩き何走目（休み明け1走目/2走目）
* 連闘フラグ
* 成長（年齢、キャリア走数）と最近の改善傾向（例：直近3走の指数トレンド）

---

## 3) 相対指標：同レース内での「序列」を数値化

同じレースに出る馬同士の比較は強いです（ただしリークしない集計で）。

* 斤量の順位/平均との差
* 自作能力指数（後述）の順位/平均との差
* 上がり性能（過去）順位
* 先行力（過去の前半位置）順位
* 距離適性スコア順位（距離帯TEなどで作る）

※「相対」は木系モデルで効くことが多い。
例：`horse_rating - mean(horse_rating in race)`、`rank_in_race(horse_rating)` など。

---

## 4) 展開（ペース）推定系：勝率を動かす特徴

“どの馬が逃げるか/先行が多いか”の推定は超重要です。

* 各馬の「逃げ率」「先行率」「4角5番手以内率」
* 逃げ候補数（一定閾値以上の先行力を持つ馬の数）
* 予想ペース指標：先行馬の平均前半ラップ（過去）や平均通過順位
* 自分の脚質とレースの脚質構成の相性（追い込み馬が多い/少ない 等）
* 距離変更で脚質が変わりやすい馬フラグ（過去の距離変更時の通過順変化）

---

## 5) 人（騎手・調教師・厩舎）とコンビ

**騎手**

* 騎手の総合勝率/複勝率、当該コース・距離別成績
* 乗り替わりフラグ（プラス/マイナスは学習させる）
* 騎手×競馬場、騎手×脚質（追い込みが上手い等）

**調教師・厩舎**

* 厩舎のコース別成績、クラス別成績
* 休み明けの仕上げが上手い（休養日数帯×厩舎）
* 輸送（関東→関西など）と厩舎の相性

**コンビ**

* 騎手×馬、騎手×厩舎、厩舎×馬主（取れるなら）
  → ここは **target encoding** が特に効きます。

---

## 6) 血統（種牡馬・母父）と適性

* 種牡馬×芝ダ、×距離帯、×馬場（重い馬場の強さ）
* 母父×距離/馬場
* “父系”など階層カテゴリ（Sire → SireLine）で階層TE
* 初出走条件（2歳新馬など）では血統比重が上がりがち

---

## 7) 馬体・調教・ローテ（取れるなら強い）

* 馬体重（増減）、増減の符号と大きさ（ただし「確定馬体重」なら発走前公開のタイミングを確認）
* 調教タイム（最終追い切り、坂路/ウッド、ラップ）
* ローテの質：前走のレース格、同一条件継続、距離延長短縮、転厩初戦など

---

## 8) 市場情報（オッズ系）※注意して扱う

オッズは強いですが、**いつのオッズか**でリークになります。

* 発走“前”に取得できる **前日オッズ** / **当日◯時時点のオッズ** を固定して特徴にする
* 変動量（前日→当日朝→直前）も特徴になるが、取得時刻が厳密に必要

---

## 9) 目的変数設計に合わせた派生特徴

**勝ちを狙う vs 複勝を狙う**で効く特徴が変わります。

* 勝ち：能力の上振れ（指数の最大値、速い上がりを出した経験）
* 複勝：安定性（着順分散、着差の小ささ、掲示板率）
* 穴：人気と実力の乖離（後述の“実力指数 − 人気指数”）

---

## 10) 自作「能力指数」を作ってそれを特徴量にする（超おすすめ）

過去走から1つのスカラーに圧縮した指数を作ると強いです。

例：

* タイム補正指数（場×距離×馬場で標準化したタイム）
* 上がり指数（上がり順位/上がり偏差）
* レース格補正（クラスやメンバー質で補正）
* 斤量補正

指数そのもの、直近平均との差、トレンド、最大値などを特徴に。

---

## 11) Target Encoding（TE）を“安全に”入れる設計

カテゴリが多いところ（騎手、厩舎、種牡馬、馬、コース×距離…）に効きます。

**対象カテゴリ例**

* 騎手、調教師、厩舎、種牡馬、母父
* 騎手×競馬場、騎手×距離帯、厩舎×休養週
* 馬（ただし個体IDのTEは過学習しやすいので慎重に）

**安全な作り方（必須）**

* **時系列OOF（out-of-fold）**で作る：
  学習データ各行のTEは「その行より過去のデータだけ」で集計（時系列CV）
* 平滑化（smoothing）：サンプルが少ないカテゴリは全体平均へ寄せる
  例：`(sum_y + m * global_mean) / (count + m)`
* さらにノイズ注入（tiny Gaussian noise）で過学習を抑えることもある
* 階層TE：
  例）`騎手×競馬場` が疎なら `騎手` とブレンド（backoff）

**TEのターゲット**

* `P(win)`、`P(place)`、平均着順、平均着差 など複数作ってOK
* “条件別TE”（騎手×芝ダ、種牡馬×距離帯）は効果が出やすい

---

## 12) 高次特徴：差分・交互作用・ランキング

* 交互作用：`距離変更 × 脚質`、`馬場 × 血統`、`枠 × 競馬場`、`斤量 × 先行力`
* 差分：`今回条件スコア − その馬の平均条件スコア`
* レース内ランキング：能力指数順位、先行力順位、上がり力順位
* 分布特徴：出走馬の先行力分散、能力指数分散（混戦度）

---

## 13) 実装の“現実的な優先順位”

最初に効きやすく、作りやすい順：

1. 過去N走の基本（着順/着差/上がり/通過順/休養日数/距離変更）
2. 条件適性（芝ダ・距離帯・競馬場・馬場）
3. 騎手/厩舎/種牡馬のTE（時系列OOF＋平滑化）
4. 展開（逃げ候補数、先行力集計）
5. 自作能力指数＋レース内相対指標
6. 調教/馬体重/オッズ（取得タイミングを固めてから）

