# keiba_prediction / downloader

## このプロジェクトについて

[JRDB](http://www.jrdb.com/) が提供する各種競馬データをダウンロードするためのスクリプト群です。

データの利用には JRDB のメンバーになり、Basic 認証のためのユーザIDとパスワードを入手することが必要です。

[JRDB 会員登録ページ](http://www.jrdb.com/order.html)

## 特徴

- **自動データタイプ検出**: `dataindex.html` から各カテゴリの最新版データタイプを自動抽出
- **最新版のみダウンロード**: JRDBサーバー上で利用可能な最新版データのみをダウンロード
- **自動解凍**: `.lzh` ファイルを自動的に解凍
- **自動エンコーディング変換**: CP932（Shift-JIS）から UTF-8 への自動変換
- **CSV変換**: 固定長テキストを CSV 形式に自動変換
- **スキーマダウンロード**: データ仕様書やコード表を自動ダウンロード

## 初期設定

### 環境変数の設定

`.env` ファイルを作成して環境変数を定義してください。

```env
JRDB_USER=あなたのJRDBユーザーID
JRDB_PASSWORD=あなたのJRDBパスワード
DOWNLOAD_FILE_OUTPUT_DIRECTORY=${HOME}/Desktop/keiba_prediction/downloaded_files/
```

- `JRDB_USER`: JRDB の会員登録時に発行されたユーザーID
- `JRDB_PASSWORD`: JRDB の会員登録時に発行されたパスワード
- `DOWNLOAD_FILE_OUTPUT_DIRECTORY`: ダウンロードファイルの出力先

### 必要なツール

このスクリプトは以下のツールが必要です：

- `curl`: ファイルのダウンロード
- `lha`: `.lzh` ファイルの解凍（`lhasa` をインストール）
- `iconv`: ファイルのエンコーディング変換
- `python3`: データタイプの自動抽出

macOS の場合、以下でインストールしてください：

```sh
brew install lhasa
# iconv は macOS に標準搭載
# python3 は macOS に標準搭載
```

## 使用方法

### スキーマ（仕様書）のダウンロード

データの仕様書やコード表をダウンロードします。最初に一度実行することをお勧めします。

```sh
sh download_schema.sh
```

**ダウンロード内容:**
- JRDBデータコード表（`jrdb_code.txt`）
- JRDBデータ仕様書（`jrdb_data_doc.txt`）
- 各種コード表（馬具、脚元、特記、血統系統、調教コース、追い状態）
- ACCESS用データベース（`jrdb_code.zip`）
- メンバー専用データインデックス（`dataindex.html`）

ダウンロードされたファイルは `${DOWNLOAD_FILE_OUTPUT_DIRECTORY}/schema/` に保存されます。

### 単一のファイルをダウンロード

```sh
sh downloader.sh
```

対話式でデータタイプと日付を指定します：

```
Datatype? (ex. KAA)

以下のファイルタイプが選択できます。
（dataindex.htmlから自動抽出）
===================================
KAA BAA KYF OZ OW OU OT OV CHA JRDB SKA CSA KSA TYB HJB SEC
===================================
KAA

Filedate? (ex. 220319)
yymmdd の形式で入力してください。
220319
```

ダウンロード、解凍、UTF-8 への自動変換が実行されます。

**ダウンロード例:**
- KAA220319.lzh → `Kaa/KAA220319.csv`
- BAA220319.lzh → `Baa/BAA220319.csv`
- KYF220319.lzh → `Kyf/KYF220319.csv`

### 複数のファイルを一括ダウンロード（同じ日付）

```sh
sh download_all.sh
```

対話式で日付を指定すると、`dataindex.html` から抽出した全データタイプが一括ダウンロードされます。

```
Filedate? (ex. 220319)
yymmdd の形式で入力してください。
220319
```

実行後、以下のフォルダが作成されます：

```
downloaded_files/
├── Kaa/       # KAA データ
├── Baa/       # BAA データ
├── Kyf/       # KYF データ
├── Oz/        # OZ データ
├── Ow/        # OW データ
├── Ou/        # OU データ
├── Ot/        # OT データ
├── Ov/        # OV データ
├── Cha/       # CHA データ
├── Jrdb/      # JRDB データ
├── Ska/       # SKA データ
├── Csa/       # CSA データ
├── Ksa/       # KSA データ
├── Tyb/       # TYB データ
├── Hjb/       # HJB データ
├── Sec/       # SEC データ
└── schema/    # スキーマ・仕様書
```

### 特定のデータタイプのファイルを年度ごとにダウンロード

```sh
sh bulk_downloader.sh
```

対話式でデータタイプと年度を指定します：

```
Datatype? (ex. KAA)

以下のファイルタイプが選択できます。
（dataindex.htmlから自動抽出）
===================================
KAA BAA KYF OZ OW OU OT OV CHA JRDB SKA CSA KSA TYB HJB SEC
===================================
KAA

Fileyear? (ex. 2021)
YYYY の形式で入力してください。
2021
```

指定した年度のデータが `${DOWNLOAD_FILE_OUTPUT_DIRECTORY}/Kaa/2021/` に保存されます。

### 指定日付以降のファイルを一括ダウンロード（単一データタイプ）

```sh
sh download_from_date.sh
```

対話式でデータタイプと開始日付を指定すると、その日付以降のすべてのファイルが一括ダウンロードされます：

```
Datatype? (ex. KAA)
データタイプを入力してください。
KAA

Start date? (ex. 220101)
yymmdd の形式で入力してください。
この日付以降のすべてのファイルがダウンロードされます。
220101

======================================================================
Fetching available files for KAA...
======================================================================

Found 250 file(s) to download:
======================================================================
  • KAA220101.lzh
  • KAA220102.lzh
  • KAA220103.lzh
  ...
======================================================================

Start downloading? (y/n)
y
```

**動作の仕組み:**
1. 指定されたデータタイプのindex.html（例: `http://www.jrdb.com/member/data/Kaa/`）にアクセス
2. すべての `.lzh` ファイルをリストアップ
3. ファイル名から6桁の日付（yymmdd）を抽出
4. 指定した開始日付以降のファイルをフィルタリング
5. ダウンロード対象ファイルを表示し、確認後に一括ダウンロード
6. 各ファイルを自動的に解凍、エンコード変換、CSV変換

**メリット:**
- 大量のファイルを日付範囲で一括取得可能
- サーバー上に存在する全ファイルを自動検出
- ダウンロード前に対象ファイルを確認可能

### 指定日付以降のファイルを一括ダウンロード（全データタイプ）

```sh
sh download_all_from_date.sh
```

開始日付を指定するだけで、**全データタイプ**の指定日付以降のファイルを一括ダウンロードします：

```
利用可能なデータタイプ:
======================================================================
KAA BAA KYF OZ OW OU OT OV CHA JRDB SKA CSA KSA TYB HJB SEC
======================================================================

Start date? (ex. 220101)
yymmdd の形式で入力してください。
この日付以降のすべてのファイルがダウンロードされます。
220101

======================================================================
Starting download of all data types from 220101...
======================================================================
Data types to download: KAA BAA KYF OZ OW OU OT OV CHA JRDB SKA CSA KSA TYB HJB SEC
======================================================================

###################################################################
# Processing data type: KAA
###################################################################

[各データタイプを順次処理...]

======================================================================
All downloads completed!
======================================================================

Summary:
--------
Total data types processed: 16
Successful: 15
Failed: 1

Successful data types:
  ✓ KAA
  ✓ BAA
  ✓ KYF
  ...
======================================================================
```

**特徴:**
- `download_all.sh`と`download_from_date.sh`を組み合わせた機能
- 全データタイプを自動的に処理
- 各データタイプの成功・失敗を記録し、最後にサマリーを表示
- 1990年代以前のデータ（yy >= 90）は自動除外
- 確認プロンプトに自動応答（y）してスムーズに処理

## スクリプト機能対照表

使用目的に応じて適切なスクリプトを選択してください：

| スクリプト | データタイプ | 日付範囲 | 用途 |
|-----------|------------|---------|------|
| `downloader.sh` | 単一 | 単一日付 | 特定のデータタイプの特定日付のデータをダウンロード |
| `download_all.sh` | 全タイプ | 単一日付 | すべてのデータタイプの特定日付のデータをダウンロード |
| `bulk_downloader.sh` | 単一 | 年度単位 | 特定のデータタイプの年度全体をダウンロード |
| `download_from_date.sh` | 単一 | 日付範囲 | 特定のデータタイプの指定日以降をダウンロード |
| `download_all_from_date.sh` | 全タイプ | 日付範囲 | すべてのデータタイプの指定日以降をダウンロード |
| `download_schema.sh` | - | - | データ仕様書・コード表をダウンロード |

**推奨用途:**
- **初回セットアップ**: `download_schema.sh` → `download_all_from_date.sh`
- **日々の更新**: `download_all.sh`
- **特定データの取得**: `downloader.sh` または `download_from_date.sh`

## ファイル構成

```
downloader/
├── .env                      # 環境変数設定ファイル（未追跡）
├── .gitignore                # Git 無視ファイル
├── downloader.sh             # 単一ファイルダウンロード（1データタイプ・1日付）
├── download_all.sh           # 全データタイプ一括ダウンロード（全データタイプ・1日付）
├── download_schema.sh        # スキーマ・仕様書ダウンロード
├── bulk_downloader.sh        # 年度ごとダウンロード（1データタイプ・1年度）
├── download_from_date.sh     # 指定日付以降のファイルを一括ダウンロード（1データタイプ・日付範囲）
├── download_all_from_date.sh # 指定日付以降のファイルを全データタイプ一括ダウンロード（全データタイプ・日付範囲）
├── extract_datatypes.py      # dataindex.htmlから最新データタイプを抽出
├── list_lzh_files.py         # index.htmlから全lzhファイルを抽出
└── README.md                 # このファイル
```

## 利用可能なデータタイプ

`dataindex.html` から自動抽出される最新のデータタイプは以下の通りです：

| コード | データ名 | 説明 |
|--------|---------|------|
| KAA | 開催データ | 馬場・天候予想等の開催に対するデータ |
| BAA | 番組データ | レース番組情報 |
| KYF | 競走馬データ | 競走馬ごとのデータ、IDM、各指数 |
| OZ | 基準オッズデータ | 単複、馬連の基準オッズ |
| OW | 基準オッズデータ | ワイドの基準オッズ |
| OU | 基準馬単データ | 馬単の基準オッズ |
| OT | 基準３連複データ | ３連複の基準オッズ |
| OV | 基準３連単データ | ３連単の基準オッズ |
| CHA | 調教本追切データ | 調教本追切情報 |
| JRDB | JRDBデータパック | 前日情報系データの一括パック |
| SKA | 成績拡張データ | 成績分析用（コメント等） |
| CSA | 調教師データ | 調教師データ（差分） |
| KSA | 騎手データ | 騎手データ（差分） |
| TYB | 直前情報データ | 直前情報（オッズ+パドック） |
| HJB | 払戻情報データ | 払戻情報 |
| SEC | 成績データ | 成績分析用 |

## 動作原理

1. **データタイプの抽出**: `extract_datatypes.py` が `dataindex.html` を解析し、各データカテゴリにおいて一番右側（最新版）のデータタイプのみを抽出
2. **ダウンロード**: 抽出されたデータタイプの最新版をダウンロード
3. **解凍**: `.lzh` ファイルを自動解凍
4. **エンコーディング変換**: CP932 から UTF-8 に自動変換
5. **CSV変換**: 固定長テキストを CSV 形式に変換

フォルダ命名規則：最新データタイプの最初の文字を大文字に、残りを小文字に変換して保存
- `KAA` → `Kaa/`
- `BAA` → `Baa/`
- `JRDB` → `Jrdb/`

## ライセンス

このスクリプトは個人用のプロジェクトです。JRDB データの利用は JRDB の利用規約に従ってください。
